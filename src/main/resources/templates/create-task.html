<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6366f1">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script th:src="@{/js/app.js}" defer></script>
</head>
<body>
<div class="header">
    <h1>TeamBalancer</h1>
    <div class="user-info">
        <span>üë§ <span sec:authentication="name"></span></span>
        <a th:href="@{/tasks}" class="btn btn-sm btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
        <a th:href="@{/dashboard}" class="btn btn-sm btn-secondary">üìä –î–∞—à–±–æ—Ä–¥</a>
        <form th:action="@{/logout}" method="post" style="display:inline;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="btn btn-sm btn-secondary">üö™ –í—ã–π—Ç–∏</button>
        </form>
    </div>
</div>

<div class="navigation">
    <a th:href="@{/tasks/create}" sec:authorize="hasRole('ADMIN')" class="nav-link active">
        ‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
    </a>
    <a th:href="@{/tasks}" class="nav-link">üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</a>
    <a th:href="@{/archive}" class="nav-link">üìÅ –ê—Ä—Ö–∏–≤ –∑–∞–¥–∞—á</a>
    <a th:href="@{/admin/users}" sec:authorize="hasRole('ADMIN')" class="nav-link">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
    <a th:href="@{/dashboard}" class="nav-link">üè† –ì–ª–∞–≤–Ω–∞—è</a>
    <a th:href="@{/admin/reports}" sec:authorize="hasRole('ADMIN')" class="nav-link">üìä –û—Ç—á–µ—Ç—ã</a>
</div>

<div class="content">
    <div class="card" data-animate>
        <div class="card-header">
            <h2 class="card-title">‚ûï –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏</h2>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div th:if="${successMessage}" class="alert alert-success">
            ‚úÖ <span th:text="${successMessage}"></span>
        </div>
        <div th:if="${errorMessage}" class="alert alert-error">
            ‚ùå <span th:text="${errorMessage}"></span>
        </div>

        <form th:action="@{/tasks/create}" method="post" id="taskForm" enctype="multipart/form-data">
            <div class="form-row">
                <div class="form-group">
                    <label for="title">üìù –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ *</label>
                    <input type="text" id="title" name="title" required
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" maxlength="255"
                           oninput="validateField(this)">
                    <div class="error-message" id="title-error"></div>
                </div>

                <div class="form-group">
                    <label for="userIds">üë• –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ *</label>
                    <select id="userIds" name="userIds" multiple required
                            size="5" style="height: auto;" onchange="validateField(this)">
                        <option th:each="user : ${users}"
                                th:value="${user.id}"
                                th:text="${user.username + ' (' + user.email + ')'}">
                        </option>
                    </select>
                    <div class="form-hint">
                        üñ±Ô∏è –î–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Ctrl+Click –∏–ª–∏ Shift+Click
                    </div>
                    <div class="error-message" id="userIds-error"></div>
                </div>
            </div>

            <div class="form-group">
                <label for="description">üìã –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                <textarea id="description" name="description"
                          placeholder="–û–ø–∏—à–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏..."
                          maxlength="1000"
                          rows="4"></textarea>
                <div class="char-count" id="description-count">0/1000 —Å–∏–º–≤–æ–ª–æ–≤</div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="status">üìä –°—Ç–∞—Ç—É—Å *</label>
                    <select id="status" name="status" required onchange="validateField(this)">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å --</option>
                        <option value="PENDING">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ</option>
                        <option value="IN_PROGRESS">üöß –í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                        <option value="COMPLETED">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                        <option value="CANCELLED">‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ</option>
                    </select>
                    <div class="error-message" id="status-error"></div>
                </div>

                <div class="form-group">
                    <label for="priority">üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç *</label>
                    <select id="priority" name="priority" required onchange="validateField(this)">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç --</option>
                        <option value="LOW">‚¨áÔ∏è –ù–∏–∑–∫–∏–π</option>
                        <option value="MEDIUM">‚ÜîÔ∏è –°—Ä–µ–¥–Ω–∏–π</option>
                        <option value="HIGH">‚¨ÜÔ∏è –í—ã—Å–æ–∫–∏–π</option>
                        <option value="URGENT">üî• –°—Ä–æ—á–Ω—ã–π</option>
                    </select>
                    <div class="error-message" id="priority-error"></div>
                </div>
            </div>

            <div class="form-group">
                <label for="dueDate">‚è∞ –°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                <input type="date" id="dueDate" name="dueDate"
                       min="" onchange="validateDate(this)">
                <div class="error-message" id="dueDate-error"></div>
            </div>

            <!-- –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —Ñ–∞–π–ª–æ–≤ -->
            <div class="form-group">
                <label for="files">üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input type="file" id="files" name="files" multiple
                       accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar"
                       onchange="previewFiles(this)">
                <div class="form-hint">
                    –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤. –ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä: 10MB –∫–∞–∂–¥—ã–π.
                    –†–∞–∑—Ä–µ—à–µ–Ω—ã: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, PDF, –¥–æ–∫—É–º–µ–Ω—Ç—ã Office, —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã, –∞—Ä—Ö–∏–≤—ã.
                </div>
                <div id="filePreview" class="file-preview"></div>
            </div>

            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    üíæ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
                </button>
                <a th:href="@{/tasks}" class="btn btn-secondary">‚ùå –û—Ç–º–µ–Ω–∞</a>
                <button type="reset" class="btn btn-secondary" onclick="resetForm()">‚ôªÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<script>
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã (—Å–µ–≥–æ–¥–Ω—è)
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dueDate').min = today;

        // –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è
        const description = document.getElementById('description');
        const counter = document.getElementById('description-count');

        description.addEventListener('input', function() {
            counter.textContent = `${this.value.length}/1000 —Å–∏–º–≤–æ–ª–æ–≤`;

            if (this.value.length > 900) {
                counter.style.color = '#ef4444';
            } else if (this.value.length > 700) {
                counter.style.color = '#f59e0b';
            } else {
                counter.style.color = 'var(--gray)';
            }
        });
    });

    function validateField(field) {
        const errorDiv = document.getElementById(field.id + '-error');

        if (!field.value || (field.multiple && field.selectedOptions.length === 0)) {
            showError(field, errorDiv, '–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
            return false;
        } else {
            clearError(field, errorDiv);
            return true;
        }
    }

    function validateDate(dateField) {
        const errorDiv = document.getElementById('dueDate-error');
        const selectedDate = new Date(dateField.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (dateField.value && selectedDate < today) {
            showError(dateField, errorDiv, '–î–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º');
            return false;
        } else {
            clearError(dateField, errorDiv);
            return true;
        }
    }

    function previewFiles(input) {
        const previewContainer = document.getElementById('filePreview');
        previewContainer.innerHTML = '';

        if (input.files.length > 0) {
            const fileList = document.createElement('div');
            fileList.className = 'file-list';

            for (let i = 0; i < input.files.length; i++) {
                const file = input.files[i];
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span class="file-icon">${getFileIcon(file.type)}</span>
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">(${formatFileSize(file.size)})</span>
                    <button type="button" class="btn-remove" onclick="removeFileItem(this)">√ó</button>
                `;
                fileList.appendChild(fileItem);
            }

            previewContainer.appendChild(fileList);
        }
    }

    function getFileIcon(fileType) {
        if (fileType.startsWith('image/')) return 'üñºÔ∏è';
        if (fileType.includes('pdf')) return 'üìÑ';
        if (fileType.includes('word')) return 'üìù';
        if (fileType.includes('excel')) return 'üìä';
        if (fileType.includes('zip')) return 'üì¶';
        return 'üìé';
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        else if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        else return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function removeFileItem(button) {
        button.parentElement.remove();
        // –¢–∞–∫–∂–µ –Ω—É–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å input —Ñ–∞–π–ª–∞
        const fileInput = document.getElementById('files');
        fileInput.value = '';
    }

    function showError(field, errorDiv, message) {
        field.style.borderColor = '#ef4444';
        errorDiv.textContent = message;
        errorDiv.style.color = '#ef4444';
        errorDiv.style.fontSize = '0.8rem';
        errorDiv.style.marginTop = '0.25rem';
    }

    function clearError(field, errorDiv) {
        field.style.borderColor = '';
        errorDiv.textContent = '';
    }

    function resetForm() {
        const errorMessages = document.querySelectorAll('.error-message');
        errorMessages.forEach(div => div.textContent = '');

        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => input.style.borderColor = '');

        document.getElementById('filePreview').innerHTML = '';
        document.getElementById('description-count').textContent = '0/1000 —Å–∏–º–≤–æ–ª–æ–≤';
        document.getElementById('description-count').style.color = 'var(--gray)';
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    document.getElementById('taskForm').addEventListener('submit', function(e) {
        const requiredFields = ['title', 'userIds', 'status', 'priority'];
        let isValid = true;

        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (!validateField(field)) {
                isValid = false;
            }
        });

        const dateField = document.getElementById('dueDate');
        if (dateField.value && !validateDate(dateField)) {
            isValid = false;
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤
        const fileInput = document.getElementById('files');
        if (fileInput.files.length > 0) {
            for (let file of fileInput.files) {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`–§–∞–π–ª "${file.name}" –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä 10MB`);
                    isValid = false;
                    break;
                }
            }
        }

        if (!isValid) {
            e.preventDefault();
            const firstError = document.querySelector('.error-message:not(:empty)');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        } else {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerHTML = '<span class="loading"></span> –°–æ–∑–¥–∞–Ω–∏–µ...';
            submitBtn.disabled = true;
        }
    });
</script>

<style>
    .error-message {
        min-height: 1.25rem;
        font-size: 0.8rem;
    }

    .char-count {
        text-align: right;
        font-size: 0.8rem;
        color: var(--gray);
        margin-top: 0.25rem;
    }

    .form-actions {
        border-top: 2px solid var(--gray-light);
        padding-top: 1.5rem;
        margin-top: 1.5rem;
    }

    .form-hint {
        display: block;
        margin-top: 0.25rem;
        font-size: 0.8rem;
        color: var(--gray);
    }

    select[multiple] {
        min-height: 120px;
        padding: 0.5rem;
    }

    select[multiple] option {
        padding: 0.5rem;
        margin: 0.1rem 0;
        border-radius: 4px;
    }

    select[multiple] option:checked {
        background: var(--primary);
        color: white;
    }

    .file-preview {
        margin-top: 1rem;
    }

    .file-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .file-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        background: var(--gray-light);
        border-radius: var(--border-radius);
        gap: 0.75rem;
    }

    .file-icon {
        font-size: 1.2rem;
    }

    .file-name {
        flex: 1;
        font-weight: 500;
    }

    .file-size {
        color: var(--gray);
        font-size: 0.9rem;
    }

    .btn-remove {
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
</body>
</html>