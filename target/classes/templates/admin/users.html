<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6366f1">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ - TaskFlow Pro</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script th:src="@{/js/app.js}" defer></script>
</head>
<body>
<div class="header">
    <h1>üìã TaskFlow Pro</h1>
    <div class="user-info">
        <span>üë§ <span sec:authentication="name"></span></span>
        <a th:href="@{/dashboard}" class="btn btn-sm btn-secondary">üìä –î–∞—à–±–æ—Ä–¥</a>
        <form th:action="@{/logout}" method="post" style="display:inline;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="btn btn-sm btn-secondary">üö™ –í—ã–π—Ç–∏</button>
        </form>
    </div>
</div>

<div class="navigation">
    <a th:href="@{/tasks/create}" sec:authorize="hasRole('ADMIN')" class="nav-link">
        ‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
    </a>
    <a th:href="@{/tasks}" class="nav-link">üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</a>
    <a th:href="@{/archive}" class="nav-link">üìÅ –ê—Ä—Ö–∏–≤ –∑–∞–¥–∞—á</a>
    <a th:href="@{/admin/users}" sec:authorize="hasRole('ADMIN')" class="nav-link active">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
    <a th:href="@{/dashboard}" class="nav-link">üè† –ì–ª–∞–≤–Ω–∞—è</a>
</div>

<div class="content">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
            <div class="stats-badge">
                üìä –í—Å–µ–≥–æ: <span th:text="${users != null ? #lists.size(users) : '0'}"></span>
            </div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div th:if="${param.success}" class="alert alert-success">
            ‚úÖ
            <span th:if="${param.success == 'created'}">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!</span>
            <span th:if="${param.success == 'updated'}">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!</span>
            <span th:if="${param.success == 'deleted'}">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!</span>
        </div>

        <div th:if="${param.error}" class="alert alert-error">
            ‚ùå
            <span th:if="${param.error == 'not_found'}">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!</span>
            <span th:if="${param.error == 'load'}">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!</span>
            <span th:if="${param.error == 'update'}">–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!</span>
            <span th:if="${param.error == 'delete'}">–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!</span>
        </div>

        <!-- –§–æ—Ä–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="form-container">
            <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>

            <form th:action="@{/admin/users/create}" method="post">
                <div class="form-row">
                    <div class="form-group">
                        <label for="username">üë§ –õ–æ–≥–∏–Ω *</label>
                        <input type="text" id="username" name="username" required
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                    </div>

                    <div class="form-group">
                        <label for="password">üîë –ü–∞—Ä–æ–ª—å *</label>
                        <input type="password" id="password" name="password" required
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="email">üìß Email *</label>
                        <input type="email" id="email" name="email" required
                               placeholder="–í–≤–µ–¥–∏—Ç–µ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                    </div>

                    <div class="form-group">
                        <label for="fullName">üë®‚Äçüíº –ü–æ–ª–Ω–æ–µ –∏–º—è</label>
                        <input type="text" id="fullName" name="fullName"
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è">
                    </div>
                </div>

                <div class="form-group">
                    <label for="role">üé≠ –†–æ–ª—å *</label>
                    <select id="role" name="role" required>
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å --</option>
                        <option value="USER">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                        <option value="ADMIN">üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    </select>
                </div>

                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        ‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    </button>
                    <button type="reset" class="btn btn-secondary">‚ôªÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
            </form>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div class="users-section">
            <div class="section-header">
                <h3>üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                <div class="section-actions">
                    <button class="btn btn-sm btn-secondary" onclick="location.reload()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            </div>

            <div th:if="${users != null and !users.empty}">
                <div class="table-container">
                    <table class="table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>üë§ –õ–æ–≥–∏–Ω</th>
                            <th>üìß Email</th>
                            <th>üë®‚Äçüíº –ò–º—è</th>
                            <th>üé≠ –†–æ–ª—å</th>
                            <th>‚ö° –î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="user : ${users}" class="user-row">
                            <td th:text="${user?.id} ?: 'N/A'"></td>
                            <td>
                                <strong th:text="${user?.username} ?: '–ù–µ —É–∫–∞–∑–∞–Ω'"></strong>
                            </td>
                            <td th:text="${user?.email} ?: '–ù–µ —É–∫–∞–∑–∞–Ω'"></td>
                            <td th:text="${user?.fullName} ?: '–ù–µ —É–∫–∞–∑–∞–Ω–æ'"></td>
                            <td>
                                <span th:if="${user?.role == 'ADMIN'}"
                                      class="role-badge role-admin">üëë –ê–¥–º–∏–Ω</span>
                                <span th:if="${user?.role == 'USER'}"
                                      class="role-badge role-user">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                                <span th:if="${user?.role == null}"
                                      class="role-badge">‚ùì –ù–µ —É–∫–∞–∑–∞–Ω–∞</span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a th:href="@{'/admin/users/edit/' + ${user?.id}}"
                                       class="btn btn-sm btn-primary" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                        ‚úèÔ∏è
                                    </a>
                                    <form th:action="@{'/admin/users/delete/' + ${user?.id}}"
                                          method="post" style="display:inline;">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                        <button type="submit" class="btn btn-sm btn-danger"
                                                onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')"
                                                title="–£–¥–∞–ª–∏—Ç—å">
                                            üóëÔ∏è
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div th:if="${users == null or users.empty}" class="empty-state">
                <div style="text-align: center; padding: 3rem; color: var(--gray);">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üë•</div>
                    <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–º–æ—â—å—é —Ñ–æ—Ä–º—ã –≤—ã—à–µ</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .stats-badge {
        background: var(--primary);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 2rem 0 1rem 0;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--gray-light);
    }

    .section-header h3 {
        margin: 0;
        color: var(--dark);
    }

    .user-row {
        transition: all 0.3s ease;
    }

    .user-row:hover {
        background: #f8f9fa !important;
        transform: scale(1.01);
    }

    .role-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
    }

    .role-admin {
        background: var(--primary);
        color: white;
    }

    .role-user {
        background: var(--success);
        color: white;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        background: var(--gray-light);
        border-radius: var(--border-radius);
        margin: 1rem 0;
    }

    .users-section {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid var(--gray-light);
    }

    @media (max-width: 768px) {
        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .action-buttons {
            flex-direction: column;
        }

        .action-buttons .btn {
            width: 100%;
        }

        .table {
            font-size: 0.8rem;
        }

        .table th,
        .table td {
            padding: 0.5rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Users management page loaded');

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const createForm = document.querySelector('form');
        if (createForm) {
            createForm.addEventListener('submit', function(e) {
                const submitBtn = createForm.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = '<span class="loading"></span> –°–æ–∑–¥–∞–Ω–∏–µ...';
                    submitBtn.disabled = true;
                }
            });
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        const userRows = document.querySelectorAll('.user-row');
        userRows.forEach(row => {
            row.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#f8f9fa';
            });
            row.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '';
            });
        });
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
    function confirmDelete(userId, userName) {
        return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "' + userName + '"?');
    }
</script>
</body>
</html>