<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6366f1">
    <title th:text="'–ó–∞–¥–∞—á–∞ #' + ${task?.id} + ' - TaskFlow Pro'">–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞—á–∏ - TaskFlow Pro</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script th:src="@{/js/app.js}" defer></script>
</head>
<body>
<div class="header">
    <h1>üìã TaskFlow Pro</h1>
    <div class="user-info">
        <span>üë§ <span sec:authentication="name"></span></span>
        <a th:href="@{/tasks}" class="btn btn-sm btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
        <a th:href="@{/dashboard}" class="btn btn-sm btn-secondary">üìä –î–∞—à–±–æ—Ä–¥</a>
        <form th:action="@{/logout}" method="post" style="display:inline;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="btn btn-sm btn-secondary">üö™ –í—ã–π—Ç–∏</button>
        </form>
    </div>
</div>

<div class="navigation">
    <a th:href="@{/tasks/create}" sec:authorize="hasRole('ADMIN')" class="nav-link">
        ‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
    </a>
    <a th:href="@{/tasks}" class="nav-link">üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</a>
    <a th:href="@{/archive}" class="nav-link">üìÅ –ê—Ä—Ö–∏–≤ –∑–∞–¥–∞—á</a>
    <a th:href="@{/admin/users}" sec:authorize="hasRole('ADMIN')" class="nav-link">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
    <a th:href="@{/dashboard}" class="nav-link">üè† –ì–ª–∞–≤–Ω–∞—è</a>
    <a th:href="@{/admin/reports}" sec:authorize="hasRole('ADMIN')" class="nav-link">üìä –û—Ç—á–µ—Ç—ã</a>
</div>

<div class="content">
    <div class="card">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="card-header">
            <h2 class="card-title">–ó–∞–¥–∞—á–∞ #<span th:text="${task?.id} ?: 'N/A'"></span></h2>
            <div class="task-meta">
                <span th:if="${task?.status?.toString() == 'PENDING'}"
                      class="status-badge status-pending">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ</span>
                <span th:if="${task?.status?.toString() == 'IN_PROGRESS'}"
                      class="status-badge status-in-progress">üöß –í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>
                <span th:if="${task?.status?.toString() == 'COMPLETED'}"
                      class="status-badge status-completed">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                <span th:if="${task?.status?.toString() == 'CANCELLED'}"
                      class="status-badge status-cancelled">‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ</span>
                <span th:if="${task?.status == null}"
                      class="status-badge">‚ùì –ù–µ —É–∫–∞–∑–∞–Ω</span>

                <span th:if="${task?.priority?.toString() == 'LOW'}"
                      class="priority-badge priority-low">‚¨áÔ∏è –ù–∏–∑–∫–∏–π</span>
                <span th:if="${task?.priority?.toString() == 'MEDIUM'}"
                      class="priority-badge priority-medium">‚ÜîÔ∏è –°—Ä–µ–¥–Ω–∏–π</span>
                <span th:if="${task?.priority?.toString() == 'HIGH'}"
                      class="priority-badge priority-high">‚¨ÜÔ∏è –í—ã—Å–æ–∫–∏–π</span>
                <span th:if="${task?.priority?.toString() == 'URGENT'}"
                      class="priority-badge priority-urgent">üî• –°—Ä–æ—á–Ω—ã–π</span>
                <span th:if="${task?.priority == null}"
                      class="priority-badge">‚ùì –ù–µ —É–∫–∞–∑–∞–Ω</span>
            </div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div th:if="${param.error}" class="alert alert-error">
            ‚ùå <span th:if="${param.error == 'access_denied'}">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!</span>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="task-content">
            <div class="info-section">
                <h3>üìù –û–ø–∏—Å–∞–Ω–∏–µ</h3>
                <p th:text="${task?.description} ?: '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'"></p>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">üë• –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏:</span>
                    <div class="assignees-list">
                        <span th:if="${task?.assignees?.empty}" class="text-muted">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</span>
                        <div th:each="user : ${task?.assignees}" class="assignee-item">
                            <span class="assignee-name" th:text="${user.username}"></span>
                            <span class="assignee-email" th:text="'(' + ${user.email} + ')'"></span>
                        </div>
                    </div>
                </div>

                <div class="info-item">
                    <span class="info-label">üìÖ –°–æ–∑–¥–∞–Ω–∞:</span>
                    <span class="info-value"
                          th:if="${task?.createdAt != null}"
                          th:text="${#temporals.format(task.createdAt, 'dd.MM.yyyy')}"></span>
                    <span class="info-value" th:unless="${task?.createdAt != null}">–ù–µ —É–∫–∞–∑–∞–Ω–∞</span>
                </div>

                <div class="info-item">
                    <span class="info-label">‚è∞ –°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</span>
                    <span class="info-value"
                          th:if="${task?.dueDate != null}"
                          th:text="${#temporals.format(task.dueDate, 'dd.MM.yyyy')}"></span>
                    <span class="info-value" th:unless="${task?.dueDate != null}">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                    <span th:if="${task?.dueDate != null and task.dueDate.isBefore(T(java.time.LocalDate).now()) and task.status?.toString() != 'COMPLETED'}"
                          class="text-danger">‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞</span>
                </div>

                <div class="info-item" th:if="${task?.archived}">
                    <span class="info-label">üìÅ –í –∞—Ä—Ö–∏–≤–µ —Å:</span>
                    <span class="info-value"
                          th:if="${task?.archivedDate != null}"
                          th:text="${#temporals.format(task.archivedDate, 'dd.MM.yyyy')}"></span>
                    <span class="info-value" th:unless="${task?.archivedDate != null}">–ù–µ —É–∫–∞–∑–∞–Ω–∞</span>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã -->
        <div class="attachments-section" th:if="${task?.attachments != null and not task.attachments.empty}">
            <h3>üìé –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</h3>
            <div class="attachments-list">
                <div th:each="file : ${task.attachments}" class="attachment-item">
                    <div class="attachment-icon" th:text="${file.fileIcon}"></div>
                    <div class="attachment-info">
                        <div class="attachment-name" th:text="${file.originalFilename}"></div>
                        <div class="attachment-meta">
                            <span th:text="${file.formattedFileSize}"></span>
                            <span>‚Ä¢</span>
                            <span th:text="${#temporals.format(file.uploadedAt, 'dd.MM.yyyy HH:mm')}"></span>
                        </div>
                    </div>
                    <div class="attachment-actions">
                        <a th:href="@{'/files/download/' + ${file.id}}"
                           class="btn btn-sm btn-primary" title="–°–∫–∞—á–∞—Ç—å">üì•</a>
                        <span class="btn btn-sm btn-secondary"
                              title="–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è">üóëÔ∏è</span>
                    </div>
                </div>
            </div>
            <div class="form-hint" style="margin-top: 1rem;">
                üí° <strong>–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤:</strong> –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤
                <a th:href="@{'/tasks/update/' + ${task?.id}}" style="color: var(--primary);">—Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏</a>
            </div>
        </div>

        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <div class="task-actions">
            <a th:href="@{/tasks}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
            <a th:href="@{'/tasks/update/' + ${task?.id}}" class="btn btn-primary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>

            <form th:action="@{'/tasks/complete/' + ${task?.id}}" method="post" style="display:inline;"
                  th:if="${task?.status?.toString() != 'COMPLETED'}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="btn btn-success">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </form>

            <form th:action="@{'/archive/archive/' + ${task?.id}}" method="post" style="display:inline;"
                  th:if="${task?.status?.toString() == 'COMPLETED' and not task?.archived}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="btn btn-warning">üìÅ –í –∞—Ä—Ö–∏–≤</button>
            </form>

            <form th:action="@{'/tasks/delete/' + ${task?.id}}" method="post" style="display:inline;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="btn btn-danger"
                        onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </form>
        </div>
    </div>
</div>

<style>
    .task-meta {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .info-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: var(--gray-light);
        border-radius: var(--border-radius);
    }

    .info-section h3 {
        margin: 0 0 1rem 0;
        color: var(--dark);
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .info-item {
        background: white;
        padding: 1.5rem;
        border-radius: var(--border-radius);
        border-left: 4px solid var(--primary);
    }

    .info-label {
        display: block;
        font-weight: 600;
        color: var(--gray);
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .info-value {
        font-size: 1.1rem;
        color: var(--dark);
        font-weight: 500;
    }

    .assignees-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .assignee-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: var(--gray-light);
        border-radius: var(--border-radius);
    }

    .assignee-name {
        font-weight: 600;
    }

    .assignee-email {
        font-size: 0.8rem;
        color: var(--gray);
    }

    .text-muted {
        color: var(--gray);
        font-style: italic;
    }

    .text-danger {
        color: var(--danger);
        font-weight: 600;
        display: block;
        margin-top: 0.5rem;
    }

    .task-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        padding-top: 1.5rem;
        border-top: 2px solid var(--gray-light);
    }

    .attachments-section {
        margin: 2rem 0;
        padding: 1.5rem;
        background: var(--gray-light);
        border-radius: var(--border-radius);
    }

    .attachment-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        background: white;
        border-radius: var(--border-radius);
        margin-bottom: 0.5rem;
        transition: var(--transition);
    }

    .attachment-item:hover {
        transform: translateX(5px);
        box-shadow: var(--shadow);
    }

    .attachment-icon {
        font-size: 2rem;
        margin-right: 1rem;
    }

    .attachment-info {
        flex: 1;
    }

    .attachment-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .attachment-meta {
        font-size: 0.8rem;
        color: var(--gray);
    }

    .attachment-actions {
        display: flex;
        gap: 0.5rem;
    }

    @media (max-width: 768px) {
        .task-meta {
            flex-direction: column;
            align-items: flex-start;
        }

        .info-grid {
            grid-template-columns: 1fr;
        }

        .task-actions {
            flex-direction: column;
        }

        .task-actions .btn {
            width: 100%;
        }

        .attachment-item {
            flex-direction: column;
            align-items: flex-start;
        }

        .attachment-actions {
            width: 100%;
            justify-content: flex-end;
            margin-top: 0.5rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Task view page loaded');
    });
</script>
</body>
</html>